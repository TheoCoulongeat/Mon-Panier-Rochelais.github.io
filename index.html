<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Panier Rochelais</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <style> 
        body { background-color: #0B2822; color: #F5F1E8; } 
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // ============================================================================
        // üëáüëá CONFIGURATION üëáüëá
        // ============================================================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYc_3ieQjpTTiebFG306gbAmGUq015rcgpIxBaAVTD67PTOdvaoWP5OPPLd9mBx13VHw/exec'; 
        
        const REPO_BASE = 'https://raw.githubusercontent.com/TheoCoulongeat/Mon-Panier-Rochelais.github.io/main';
        const CSV_MASTER_URL = `${REPO_BASE}/donnees.csv`;
        const LOGO_URL        = `${REPO_BASE}/Logo.png`;
        // ============================================================================

        const { useState, useEffect } = React;

        // --- ICONES ---
        const ChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>;
        const ChevronUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>;
        const ShoppingBasket = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m5 11 4-7"/><path d="m19 11-4-7"/><path d="M2 11h20"/><path d="m3.5 11 1.6 7.4a2 2 0 0 0 2 1.6h9.8c.9 0 1.8-.7 2-1.6l1.7-7.4"/><path d="m9 11 1 9"/><path d="m4.5 11 .1 9"/><path d="m15 11-1 9"/></svg>;
        const Plus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const Minus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/></svg>;
        const Check = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 6 9 17l-5-5"/></svg>;
        const Loader = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const Truck = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>;
        const MapPin = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;

        function MonPanierRochelais() {
            const [composition, setComposition] = useState([]);
            const [config, setConfig] = useState({ panierPrice: 31.90, extras: [], pickupDays: [] });
            
            // üëá ETATS IMPORTANTS POUR LA GESTION DU QUOTA üëá
            const [deliveryAllowedByCSV, setDeliveryAllowedByCSV] = useState(false); // R√©glage Manuel (CSV)
            const [deliveryAllowedByQuota, setDeliveryAllowedByQuota] = useState(true); // R√©glage Automatique (Script)
            
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(false);
            const [showComposition, setShowComposition] = useState(false);
            const [selectedDay, setSelectedDay] = useState(null);
            const [orderConfirmed, setOrderConfirmed] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const [deliveryMode, setDeliveryMode] = useState('pickup');
            const [address, setAddress] = useState('');
            const [formData, setFormData] = useState({ firstName: '', lastName: '', phone: '', email: '', location: '', basketCount: 1, replacement: '', extras: {}, comment: '' });

            useEffect(() => {
                // 1. Charger le CSV
                Papa.parse(CSV_MASTER_URL, {
                    download: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        try {
                            const rawData = results.data;
                            let currentSection = '';
                            let tempPrice = 31.90;
                            let tempDelivery = false; 
                            let tempCompo = [];
                            let tempExtras = [];
                            let tempDeadlines = [];
                            let tempLieux = [];

                            rawData.forEach(row => {
                                if (row.length === 0) return;
                                const firstCell = (row[0] || '').trim();
                                if (firstCell.startsWith('//')) return;
                                if (firstCell.startsWith('[') && firstCell.endsWith(']')) { currentSection = firstCell; return; }

                                if (currentSection === '[CONFIG]') {
                                    if (firstCell === 'PRIX') tempPrice = parseFloat((row[1] || '0').replace(',', '.'));
                                    // üëâ ICI : On lit si vous avez mis LIVRAISON,OUI dans le CSV
                                    if (firstCell === 'LIVRAISON') tempDelivery = (row[1] || '').trim().toUpperCase() === 'OUI';
                                }
                                else if (currentSection === '[PANIER]') { if (row[1]) tempCompo.push({ nom: firstCell, quantite: row[1] }); }
                                else if (currentSection === '[EXTRAS]') { if (row[1]) tempExtras.push({ id: tempExtras.length + 1, name: firstCell, price: parseFloat((row[1] || '0').replace(',', '.')) }); }
                                else if (currentSection === '[DEADLINES]') { if (row[1] && row[2]) tempDeadlines.push({ jour: firstCell, fullDate: `${row[1]}T${row[2]}` }); }
                                else if (currentSection === '[LIEUX]') { if (row[1]) tempLieux.push({ jour: firstCell, lieu: row[1] }); }
                            });

                            const daysMap = {};
                            tempDeadlines.forEach(d => {
                                const key = d.jour.toLowerCase();
                                daysMap[key] = { id: key, label: d.jour, deadline: d.fullDate, locations: [] };
                            });
                            tempLieux.forEach(l => {
                                const key = l.jour.toLowerCase();
                                if (daysMap[key]) daysMap[key].locations.push(l.lieu);
                            });

                            setComposition(tempCompo);
                            setConfig({ panierPrice: tempPrice, extras: tempExtras, pickupDays: Object.values(daysMap) });
                            setDeliveryAllowedByCSV(tempDelivery); // On active/d√©sactive selon le CSV
                            setLoading(false);

                        } catch (err) { console.error("Erreur parsing", err); setError(true); setLoading(false); }
                    },
                    error: () => { setError(true); setLoading(false); }
                });

                // 2. üëâ ICI : ON DEMANDE AU SCRIPT SI C'EST COMPLET
                if (GOOGLE_SCRIPT_URL.includes('http')) {
                    fetch(GOOGLE_SCRIPT_URL)
                        .then(res => res.json())
                        .then(data => {
                            console.log("Compteur livraisons re√ßu :", data);
                            // Si le script dit "false" (plus de place), on bloque.
                            if (data.disponible === false) {
                                setDeliveryAllowedByQuota(false); 
                            }
                        })
                        .catch(err => console.log("Erreur v√©rification quota :", err));
                }

            }, []);

            const isDayAvailable = (deadline) => {
                if(!deadline) return true;
                return new Date() < new Date(deadline);
            };

            // 3. üëâ ICI : LA LOGIQUE FINALE D'AFFICHAGE
            const isDeliveryOptionAvailable = () => {
                // IL FAUT QUE :
                // 1. Le CSV dise OUI (Manuel)
                // 2. Le Script dise OUI (Quota pas atteint)
                if (!deliveryAllowedByCSV || !deliveryAllowedByQuota) return false;
                
                const dayObj = config.pickupDays.find(d => d.id === selectedDay);
                if (!dayObj) return false;
                const dayName = dayObj.label.toLowerCase();
                return dayName.includes('jeudi') || dayName.includes('samedi');
            };

            const calculateTotal = () => {
                let total = config.panierPrice * formData.basketCount;
                Object.entries(formData.extras).forEach(([id, qty]) => {
                    if (qty > 0) { const extra = config.extras.find(e => e.id === parseInt(id)); if (extra) total += extra.price * qty; }
                });
                return total.toFixed(2);
            };

            const updateExtraQty = (id, delta) => {
                setFormData(prev => ({ ...prev, extras: { ...prev.extras, [id]: Math.max(0, (prev.extras[id] || 0) + delta) } }));
            };

            const handleDayChange = (dayId) => {
                setSelectedDay(dayId);
                setFormData(p => ({...p, location: ''}));
                setDeliveryMode('pickup');
                setAddress('');
            };

            const handleSubmit = async () => {
                if (!formData.firstName || !formData.lastName) { alert('Merci de renseigner votre Nom et Pr√©nom.'); return; }
                
                let finalLocation = '';
                if (deliveryMode === 'delivery') {
                    if (!address || address.length < 5) { alert('Merci de renseigner une adresse compl√®te pour la livraison.'); return; }
                    finalLocation = `LIVRAISON DOMICILE : ${address}`;
                } else {
                    if (!formData.location) { alert('Merci de s√©lectionner un lieu de retrait.'); return; }
                    finalLocation = formData.location;
                }

                if (!formData.phone && !formData.email) { alert('Veuillez indiquer au moins un moyen de contact.'); return; }

                setIsSubmitting(true);
                const extrasText = Object.entries(formData.extras).filter(([_, qty]) => qty > 0).map(([id, qty]) => { const ex = config.extras.find(e => e.id === parseInt(id)); return ex ? `${ex.name} x${qty}` : ''; }).join(', ');
                
                const orderData = {
                    date: new Date().toLocaleString('fr-FR'), firstName: formData.firstName, lastName: formData.lastName, 
                    phone: formData.phone, email: formData.email, pickupDay: config.pickupDays.find(d => d.id === selectedDay)?.label, 
                    location: finalLocation, basketCount: formData.basketCount, total: calculateTotal().replace('.', ','), 
                    replacement: formData.replacement, extras: extrasText, comment: formData.comment
                };
                
                try {
                    await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) });
                    setOrderConfirmed(true);
                } catch (err) { console.error(err); setOrderConfirmed(true); }
                setIsSubmitting(false);
            };

            if (orderConfirmed) return (
                <div className="min-h-screen bg-[#0B2822] text-[#F5F1E8] p-4">
                    <div className="max-w-md mx-auto pt-20 text-center">
                        <div className="bg-green-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><Check className="w-12 h-12 text-white" /></div>
                        <h2 className="text-2xl font-bold mb-4">Commande enregistr√©e !</h2>
                        <p className="mb-6">{formData.email ? <span>Un email de confirmation a √©t√© envoy√© √† <strong>{formData.email}</strong>.</span> : <span>Pensez √† faire une capture d'√©cran de cette page.</span>}</p>
                        <div className="bg-[#1a3d36] p-6 rounded-lg mb-6 text-left space-y-2">
                            <p><strong>Nom :</strong> {formData.firstName} {formData.lastName}</p>
                            <p><strong>Retrait :</strong> {config.pickupDays.find(d => d.id === selectedDay)?.label}</p>
                            <p><strong>Lieu :</strong> {deliveryMode === 'delivery' ? `LIVRAISON : ${address}` : formData.location}</p>
                            <p><strong>Total :</strong> {calculateTotal()} ‚Ç¨</p>
                        </div>
                        <button onClick={() => window.location.reload()} className="bg-[#F5F1E8] text-[#0B2822] px-6 py-3 rounded-lg font-semibold hover:bg-[#e5e1d8] transition-colors">Nouvelle commande</button>
                    </div>
                </div>
            );

            if (loading) return <div className="min-h-screen flex items-center justify-center text-[#F5F1E8]"><Loader className="animate-spin mr-2"/> Chargement des produits...</div>;
            if (error) return <div className="min-h-screen flex items-center justify-center text-red-400 text-center p-4">Erreur de chargement. V√©rifiez que "donnees.csv" est bien cr√©√© sur GitHub.</div>;

            return (
                <div className="min-h-screen bg-[#0B2822] text-[#F5F1E8] pb-20">
                    <div className="text-center pt-8 pb-6 px-4">
                        <div className="w-24 h-24 rounded-full mx-auto mb-4 overflow-hidden flex items-center justify-center bg-[#F5F1E8]">
                            {LOGO_URL && LOGO_URL.includes('http') ? (<img src={LOGO_URL} alt="Mon Panier Rochelais" className="w-full h-full object-cover" />) : (<ShoppingBasket className="w-12 h-12 text-[#0B2822]" />)}
                        </div>
                        <h1 className="text-3xl font-bold mb-2">Mon Panier Rochelais</h1>
                        <p className="text-[#F5F1E8]/80">Bienvenue sur l'espace de r√©servation</p>
                    </div>
                    <div className="max-w-md mx-auto px-4">
                        <div className="mb-6">
                            <button onClick={() => setShowComposition(!showComposition)} className="w-full bg-[#1a3d36] p-4 rounded-lg flex items-center justify-between hover:bg-[#234d45] transition-colors"><span className="font-semibold text-lg">ü•¨ Composition de la semaine</span>{showComposition ? <ChevronUp /> : <ChevronDown />}</button>
                            {showComposition && (<div className="bg-[#1a3d36] mt-2 p-4 rounded-lg"><p className="font-semibold mb-3">Panier √† {config.panierPrice} ‚Ç¨</p><ul className="space-y-2">{composition.map((item, i) => (<li key={i} className="flex items-center justify-between"><div className="flex items-center"><span className="w-2 h-2 bg-[#F5F1E8] rounded-full mr-3"></span><span>{item.nom}</span></div><span className="text-[#F5F1E8]/70 text-sm">{item.quantite}</span></li>))}</ul></div>)}
                        </div>
                        
                        <div className="mb-6"><h2 className="text-xl font-bold mb-4">üìÖ Choisir le jour</h2>
                            <div className="grid grid-cols-2 gap-3">
                                {config.pickupDays.map(day => { 
                                    if (!isDayAvailable(day.deadline)) return null; 
                                    return (
                                        <button key={day.id} onClick={() => handleDayChange(day.id)} className={`p-4 rounded-lg font-semibold transition-all ${selectedDay === day.id ? 'bg-[#F5F1E8] text-[#0B2822] scale-105 ring-4 ring-[#F5F1E8]/50' : 'bg-[#1a3d36] hover:bg-[#234d45] border-2 border-transparent'}`}>{day.label}</button>
                                    ); 
                                })}
                            </div>
                        </div>

                        {selectedDay && (
                            <div className="space-y-6">
                                <div className="bg-[#1a3d36] p-4 rounded-lg space-y-4"><h3 className="font-semibold text-lg">üë§ Vos coordonn√©es</h3><div className="grid grid-cols-2 gap-2"><input type="text" placeholder="Pr√©nom *" value={formData.firstName} onChange={e => setFormData({...formData, firstName: e.target.value})} className="bg-[#0B2822] p-3 rounded border border-[#F5F1E8]/20 w-full" /><input type="text" placeholder="Nom *" value={formData.lastName} onChange={e => setFormData({...formData, lastName: e.target.value})} className="bg-[#0B2822] p-3 rounded border border-[#F5F1E8]/20 w-full" /></div><div className="pt-2 border-t border-[#F5F1E8]/10"><p className="text-xs text-[#F5F1E8]/70 mb-2 uppercase font-bold">Moyen de contact (Remplir au moins l'un des deux)</p><div className="space-y-2"><input type="tel" placeholder="T√©l√©phone" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} className="w-full bg-[#0B2822] p-3 rounded border border-[#F5F1E8]/20 focus:border-[#F5F1E8]/50 outline-none" /><input type="email" placeholder="Email (pour confirmation)" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className="w-full bg-[#0B2822] p-3 rounded border border-[#F5F1E8]/20 focus:border-[#F5F1E8]/50 outline-none" /></div></div></div>
                                
                                <div className="bg-[#1a3d36] p-4 rounded-lg">
                                    <h3 className="font-semibold text-lg mb-3">üìç Mode de r√©cup√©ration</h3>
                                    
                                    {isDeliveryOptionAvailable() && (
                                        <div className="flex gap-2 mb-4 p-1 bg-[#0B2822] rounded-lg">
                                            <button onClick={() => setDeliveryMode('pickup')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-md transition-all ${deliveryMode === 'pickup' ? 'bg-[#F5F1E8] text-[#0B2822] font-bold shadow' : 'text-[#F5F1E8]/70 hover:text-[#F5F1E8]'}`}>
                                                <MapPin size={18} /> Point de retrait
                                            </button>
                                            <button onClick={() => setDeliveryMode('delivery')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-md transition-all ${deliveryMode === 'delivery' ? 'bg-[#F5F1E8] text-[#0B2822] font-bold shadow' : 'text-[#F5F1E8]/70 hover:text-[#F5F1E8]'}`}>
                                                <Truck size={18} /> A Domicile
                                            </button>
                                        </div>
                                    )}

                                    {deliveryMode === 'delivery' && isDeliveryOptionAvailable() ? (
                                        <div className="space-y-2 animate-fadeIn">
                                            <label className="text-sm font-semibold text-[#F5F1E8]/80">Votre adresse de livraison :</label>
                                            <textarea placeholder="N¬∞, Rue, Code Postal, Ville, Code d'acc√®s..." value={address} onChange={e => setAddress(e.target.value)} className="w-full bg-[#0B2822] p-3 rounded border border-[#F5F1E8]/20 focus:border-[#F5F1E8]/50 outline-none h-24" />
                                            <p className="text-xs text-yellow-300 italic">‚ö†Ô∏è Attention : Le nombre de livraisons est limit√©.</p>
                                        </div>
                                    ) : (
                                        <div>
                                            <label className="text-sm font-semibold text-[#F5F1E8]/80 block mb-2">Choisir un point de retrait :</label>
                                            <select value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} className="w-full bg-[#0B2822] p-3 rounded border border-[#F5F1E8]/20 focus:border-[#F5F1E8]/50 outline-none"><option value="">S√©lectionner un lieu</option>{config.pickupDays.find(d => d.id === selectedDay)?.locations.map((loc, i) => (<option key={i} value={loc}>{loc}</option>))}</select>
                                        </div>
                                    )}
                                </div>

                                <div className="bg-[#1a3d36] p-4 rounded-lg"><h3 className="font-semibold text-lg mb-3">üß∫ Nombre de paniers</h3><div className="flex gap-3">{[1, 2, 3].map(n => (<button key={n} type="button" onClick={() => setFormData({...formData, basketCount: n})} className={`flex-1 p-3 rounded font-semibold transition-all ${formData.basketCount === n ? 'bg-[#F5F1E8] text-[#0B2822] ring-4 ring-[#F5F1E8]/50' : 'bg-[#0B2822] hover:bg-[#0f3229] border-2 border-transparent'}`}>{n}</button>))}</div></div>
                                <div className="bg-[#1a3d36] p-4 rounded-lg"><h3 className="font-semibold text-lg mb-3">üîÑ Remplacement</h3><select value={formData.replacement} onChange={e => setFormData({...formData, replacement: e.target.value})} className="w-full bg-[#0B2822] p-3 rounded border border-[#F5F1E8]/20 focus:border-[#F5F1E8]/50 outline-none"><option value="">Aucun remplacement</option>{composition.map((item, i) => (<option key={i} value={item.nom}>{item.nom} ‚Üí Pommes de terre</option>))}</select></div>
                                <div className="bg-[#1a3d36] p-4 rounded-lg"><h3 className="font-semibold text-lg mb-4">‚ûï Ventes compl√©mentaires</h3>{config.extras.map(extra => (<div key={extra.id} className="flex items-center justify-between mb-3 pb-3 border-b border-[#F5F1E8]/10 last:border-0 last:mb-0 last:pb-0"><div><p className="font-medium">{extra.name}</p><p className="text-sm text-[#F5F1E8]/70">{extra.price.toFixed(2)} ‚Ç¨</p></div><div className="flex items-center gap-2"><button type="button" onClick={() => updateExtraQty(extra.id, -1)} className="bg-[#0B2822] p-2 rounded hover:bg-[#0f3229] transition-colors"><Minus /></button><span className="w-8 text-center font-semibold">{formData.extras[extra.id] || 0}</span><button type="button" onClick={() => updateExtraQty(extra.id, 1)} className="bg-[#0B2822] p-2 rounded hover:bg-[#0f3229] transition-colors"><Plus /></button></div></div>))}</div>
                                <div className="bg-[#1a3d36] p-4 rounded-lg space-y-4"><div><h3 className="font-semibold text-lg mb-3">üí¨ Commentaire</h3><textarea placeholder="Infos supp..." value={formData.comment} onChange={e => setFormData({...formData, comment: e.target.value})} className="w-full bg-[#0B2822] p-3 rounded border border-[#F5F1E8]/20 focus:border-[#F5F1E8]/50 outline-none resize-none" rows="3" /></div><div className="border-t border-[#F5F1E8]/10 pt-4"><div className="flex justify-between items-center mb-4"><span className="text-xl font-bold">üí∞ Total estim√©</span><span className="text-2xl font-bold">{calculateTotal()} ‚Ç¨</span></div><button onClick={handleSubmit} disabled={isSubmitting} className={`w-full py-4 rounded-lg font-bold text-lg transition-colors ${isSubmitting ? 'bg-gray-500 cursor-wait' : 'bg-[#F5F1E8] text-[#0B2822] hover:bg-[#e5e1d8]'}`}>{isSubmitting ? 'Envoi en cours...' : 'Valider ma commande'}</button></div></div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MonPanierRochelais />);
    </script>
</body>
</html>
